# pytest Quick Reference

## Running Tests

```bash
# All tests
pytest

# Verbose output
pytest -v

# Very verbose (show full diffs)
pytest -vv

# Quiet mode (minimal output)
pytest -q

# Stop on first failure
pytest -x

# Stop after N failures
pytest --maxfail=3

# Show print statements
pytest -s

# Run specific file
pytest tests/test_risk_radar.py

# Run specific class
pytest tests/test_risk_radar.py::TestRiskRadarComponent

# Run specific test
pytest tests/test_risk_radar.py::TestRiskRadarComponent::test_calculate_risk_from_analysis_with_full_data

# Run tests matching pattern
pytest -k "fetch"          # Tests with "fetch" in name
pytest -k "not slow"       # Exclude slow tests

# Run last failed tests
pytest --lf

# Run failed first, then others
pytest --ff
```

## Coverage

```bash
# Run with coverage
pytest --cov=components

# Coverage report in terminal
pytest --cov=components --cov-report=term

# Coverage report as HTML
pytest --cov=components --cov-report=html
# Open htmlcov/index.html

# Coverage report as XML (for CI)
pytest --cov=components --cov-report=xml

# Show missing lines
pytest --cov=components --cov-report=term-missing

# Fail if coverage below threshold
pytest --cov=components --cov-fail-under=80
```

## Debugging

```bash
# Show full traceback
pytest --tb=long

# Show short traceback
pytest --tb=short

# Show one line per failure
pytest --tb=line

# No traceback
pytest --tb=no

# Drop into pdb on failure
pytest --pdb

# Drop into pdb on first failure
pytest -x --pdb

# Set breakpoint in code
# Add: import pdb; pdb.set_trace()
# Or: breakpoint()  # Python 3.7+
```

## Output Control

```bash
# Show local variables in traceback
pytest -l

# Show captured output for all tests
pytest --capture=no

# Disable all output capturing
pytest -s --capture=no

# Show summary of all test outcomes
pytest -ra

# Show only failures
pytest -rf

# Show only errors
pytest -re

# Show skipped tests
pytest -rs
```

## Test Selection

```bash
# Run by marker
pytest -m "slow"           # Run slow tests
pytest -m "not slow"       # Skip slow tests

# Parametrized test selection
pytest tests/test_components.py::test_fetch_methods_exist[risk_radar-fetch_risk_radar]

# Multiple patterns
pytest -k "fetch or create"
pytest -k "test_fetch and not failure"
```

## Reporting

```bash
# JUnit XML (for CI)
pytest --junit-xml=test-results.xml

# HTML report
pytest --html=report.html --self-contained-html

# JSON report
pytest --json-report --json-report-file=report.json

# Show slowest N tests
pytest --durations=10

# Show all durations
pytest --durations=0
```

## Warnings

```bash
# Show all warnings
pytest -W all

# Treat warnings as errors
pytest -W error

# Ignore specific warnings
pytest -W ignore::DeprecationWarning

# Show warnings summary
pytest -rw
```

## Common Combinations

```bash
# Quick feedback loop (dev)
pytest -x --ff -v

# Full test run (CI)
pytest -v --cov=components --cov-report=html --junit-xml=results.xml

# Debug failed test
pytest tests/test_risk_radar.py::test_specific_test -vv --pdb

# Check coverage of new code
pytest --cov=components --cov-report=term-missing -v

# Fast incremental testing
pytest --lf -x -v
```

## Fixture Usage

```bash
# List all fixtures
pytest --fixtures

# List fixtures from specific file
pytest tests/test_risk_radar.py --fixtures

# Show fixture setup/teardown
pytest --setup-show
```

## Parallel Execution

```bash
# Install pytest-xdist
pip install pytest-xdist

# Run tests in parallel (auto CPU count)
pytest -n auto

# Run on 4 cores
pytest -n 4

# Distribute tests by file
pytest -n auto --dist loadfile
```

## Environment Variables

```bash
# Set env var for tests
API_KEY=test-key pytest

# Multiple env vars
API_KEY=test API_BASE_URL=http://localhost:3000 pytest

# Use .env file
# Create .env.test and source it
source .env.test && pytest
```

## Config File (pytest.ini)

```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --strict-markers
markers =
    slow: marks tests as slow
    integration: marks tests as integration tests
```

## Common Patterns

### Run only unit tests
```bash
pytest tests/test_config.py tests/test_risk_radar.py tests/test_paper_trading.py
```

### Run integration tests (if marked)
```bash
pytest -m integration
```

### Watch mode (requires pytest-watch)
```bash
pip install pytest-watch
ptw  # Reruns tests on file changes
```

### Generate coverage badge
```bash
pytest --cov=components --cov-report=term
# Then use coverage-badge or shields.io
```

## Troubleshooting

```bash
# Clear pytest cache
pytest --cache-clear

# Collect tests without running
pytest --collect-only

# Show available markers
pytest --markers

# Validate pytest configuration
pytest --version
pytest --help
```
